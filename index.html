<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›ç±³èŠ±æ˜¥è¯æ’ç‰ˆå·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --a4-w: 210mm; --a4-h: 297mm; }
        * { box-sizing: border-box; }
        body { background: #333; display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; font-family: sans-serif; }
        
        .toolbar { background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; text-align: center; width: 95%; max-width: 600px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        
        .preview-container { transform: scale(0.45); transform-origin: top center; height: 135mm; }
        @media (max-width: 600px) { .preview-container { transform: scale(0.35); height: 105mm; } }
        
        #a4-page {
            width: var(--a4-w); height: var(--a4-h);
            background: #BC4C41; padding: 5mm; 
            display: flex; flex-direction: column; gap: 4mm;
        }

        .row { display: flex; gap: 4mm; }
        .v-stack { display: flex; flex-direction: column; gap: 4mm; }
        .photo-container { background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer; border: 0.1mm solid rgba(255,255,255,0.2); }
        .photo-container img { width: 100%; height: 100%; object-fit: contain; display: none; }

        .size-15 { width: 150mm; height: 150mm; }
        .size-10 { width: 100mm; height: 100mm; }
        .size-5  { width: 50mm; height: 50mm; }

        .btn-group { display: flex; gap: 10px; margin-bottom: 10px; }
        .btn-fill { background: #f39c12; color: white; border: none; padding: 12px; border-radius: 4px; font-weight: bold; flex: 1; cursor: pointer; }
        .btn-main { background: #e60012; color: white; border: none; padding: 12px; border-radius: 4px; font-weight: bold; flex: 1; cursor: pointer; }
        
        #result-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 1000; flex-direction: column; align-items: center; justify-content: center;
        }
        #result-overlay img { max-width: 90%; max-height: 80%; border: 2px solid white; }
        #result-overlay p { color: white; margin-top: 15px; }
    </style>
</head>
<body>

<div class="toolbar">
    <p style="margin:0 0 10px 0; font-weight:bold;">é›ç±³èŠ±æ˜¥è¯æ’ç‰ˆå·¥å…·</p>
    
    <div class="btn-group">
        <button class="btn-fill" onclick="triggerFillAll()">âš¡ ä¸€éµå¡«æ»¿ç…§ç‰‡</button>
        <button class="btn-main" onclick="processLayout()">ğŸ’¾ ä¸‹è¼‰ A4 åœ–ç‰‡</button>
    </div>
    
    <p style="font-size: 12px; color: #666;">ä¹Ÿå¯ä»¥é»æ“Šä¸‹æ–¹æ–¹æ ¼å–®ç¨æ›´æ›ç…§ç‰‡</p>
    
    <input type="file" id="imageInput" accept="image/*" style="display:none;">
    <input type="file" id="fillAllInput" accept="image/*" style="display:none;">
</div>

<div class="preview-container">
    <div id="a4-page">
        <div class="row">
            <div class="photo-container size-15" onclick="triggerUpload(this)"><img class="preview"></div>
            <div class="v-stack">
                <div class="photo-container size-5" onclick="triggerUpload(this)"><img class="preview"></div>
                <div class="photo-container size-5" onclick="triggerUpload(this)"><img class="preview"></div>
                <div class="photo-container size-5" onclick="triggerUpload(this)"><img class="preview"></div>
            </div>
        </div>
        <div class="row">
            <div class="photo-container size-10" onclick="triggerUpload(this)"><img class="preview"></div>
            <div class="v-stack">
                <div class="photo-container size-5" onclick="triggerUpload(this)"><img class="preview"></div>
                <div class="photo-container size-5" onclick="triggerUpload(this)"><img class="preview"></div>
            </div>
            <div class="v-stack">
                <div class="photo-container size-5" onclick="triggerUpload(this)"><img class="preview"></div>
                <div class="photo-container size-5" onclick="triggerUpload(this)"><img class="preview"></div>
            </div>
        </div>
    </div>
</div>

<div id="result-overlay" onclick="this.style.display='none'">
    <p>é•·æŒ‰åœ–ç‰‡å„²å­˜ / é›»è…¦å³éµå¦å­˜</p>
    <img id="final-image">
    <button style="margin-top:20px; background:#555; color:white; border:none; padding:8px 20px;">é—œé–‰é è¦½</button>
</div>

<script>
    const imageInput = document.getElementById('imageInput');
    const fillAllInput = document.getElementById('fillAllInput');
    let currentTarget = null;

    // å–®å¼µä¸Šå‚³
    function triggerUpload(el) {
        currentTarget = el.querySelector('.preview');
        imageInput.value = '';
        imageInput.click();
    }

    imageInput.addEventListener('change', function(e) {
        handleFileSelect(e.target.files[0], (dataUrl) => {
            if (currentTarget) updatePhotoBox(currentTarget, dataUrl);
        });
    });

    // ä¸€éµå¡«æ»¿ä¸Šå‚³
    function triggerFillAll() {
        fillAllInput.value = '';
        fillAllInput.click();
    }

    fillAllInput.addEventListener('change', function(e) {
        handleFileSelect(e.target.files[0], (dataUrl) => {
            const allPreviews = document.querySelectorAll('.preview');
            allPreviews.forEach(img => updatePhotoBox(img, dataUrl));
        });
    });

    // æ ¸å¿ƒè™•ç†ï¼šæ›´æ–°ç…§ç‰‡èˆ‡æ¨£å¼
    function updatePhotoBox(imgEl, dataUrl) {
        imgEl.src = dataUrl;
        imgEl.style.display = 'block';
        const parent = imgEl.parentElement;
        parent.style.background = 'transparent';
        parent.style.border = 'none';
    }

    function handleFileSelect(file, callback) {
        if (file) {
            const reader = new FileReader();
            reader.onload = (ev) => callback(ev.target.result);
            reader.readAsDataURL(file);
        }
    }

    function processLayout() {
        const a4 = document.getElementById('a4-page');
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        
        html2canvas(a4, { scale: 2.5, useCORS: true }).then(canvas => {
            const dataUrl = canvas.toDataURL('image/png');
            if (isMobile) {
                document.getElementById('final-image').src = dataUrl;
                document.getElementById('result-overlay').style.display = 'flex';
            } else {
                const link = document.createElement('a');
                link.download = 'gimifa_chunlian_full.png';
                link.href = dataUrl;
                link.click();
            }
        });
    }
</script>

<hr>
<div style="text-align: center; margin-top: 20px;">
    <p>è‡ªè¨‚æ’ç‰ˆï¼š</p>
    <a href="./gmf/index.html" style="padding: 10px 20px; background-color: #f39c12; color: white; text-decoration: none; border-radius: 5px; font-weight: bold;">
        æ‰‹å‹•æ·»åŠ ä¸åŒå°ºå¯¸
    </a>
</div>
</body>
</html>

