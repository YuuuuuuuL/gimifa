<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›ç±³èŠ±æ˜¥è¯è‡ªè¡Œæ’ç‰ˆå·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --a4-w: 210mm; --a4-h: 297mm; }
        * { box-sizing: border-box; }
        body { background: #333; display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; font-family: sans-serif; }
        
        /* å·¥å…·åˆ—å„ªåŒ– */
        .toolbar { 
            background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; 
            text-align: center; width: 95%; max-width: 750px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); 
        }
        
        /* è¢å¹•é¡¯ç¤ºç¸®æ”¾ï¼šè§£æ±ºæ‰‹æ©Ÿä¸Š A4 å¤ªå¤§çš„å•é¡Œ */
        .preview-container { transform: scale(0.45); transform-origin: top center; height: 135mm; }
        @media (max-width: 600px) { .preview-container { transform: scale(0.32); height: 95mm; } }

        #a4-page {
            width: var(--a4-w); height: var(--a4-h);
            background: #BC4C41; padding: 2mm; 
            display: flex; flex-wrap: wrap; gap: 2mm; 
            align-content: flex-start; overflow: hidden; position: relative;
        }

        .combo-row { display: flex; gap: 2mm; align-items: flex-start; }
        .v-stack { display: flex; flex-direction: column; gap: 2mm; }

        .chun-lian {
            border: 0.5px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.05);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; overflow: hidden; position: relative; flex-shrink: 0;
        }
        .chun-lian img { width: 100%; height: 100%; object-fit: contain; }

        /* å°ºå¯¸å®šç¾© */
        .s15 { width: 150mm; height: 150mm; }
        .s10 { width: 100mm; height: 100mm; }
        .s5  { width: 50mm; height: 50mm; }
        .s4  { width: 40mm; height: 40mm; }
        .long-big { width: 50mm; height: 200mm; }
        .long-small { width: 30mm; height: 120mm; }

        .btn-group { margin: 8px 0; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        button { padding: 8px 12px; margin: 3px; cursor: pointer; border-radius: 4px; border: none; font-weight: bold; font-size: 13px; }
        .btn-combo { background: #6200ee; color: white; }
        .btn-new { background: #ff5722; color: white; }
        .btn-std { background: #03dac6; color: black; }
        .btn-save { background: #cf6679; color: white; width: 100%; margin-top: 10px; font-size: 16px; padding: 12px; }
        .label { display: block; font-size: 11px; color: #666; margin-bottom: 3px; font-weight: bold; }

        /* æ‰‹æ©Ÿå°ˆç”¨å½ˆå‡ºå±¤ */
        #result-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 1000; flex-direction: column; align-items: center; justify-content: center;
        }
        #result-overlay img { max-width: 90%; max-height: 80%; border: 2px solid white; }
        #result-overlay p { color: white; margin-top: 15px; font-weight: bold; }
    </style>
</head>
<body>

<div class="toolbar">
    <div class="btn-group">
        <span class="label">ğŸš€ ç©ºé–“æ¥µè‡´çµ„åˆ</span>
        <button class="btn-combo" onclick="addBestCombo15()">15cm çµ„åˆ (15+5*3)</button>
        <button class="btn-combo" onclick="addBestCombo10()">10cm çµ„åˆ (10+5*4)</button>
    </div>

    <div class="btn-group">
        <span class="label">âœ¨ å°è¯èˆ‡è¿·ä½ å°ºå¯¸</span>
        <button class="btn-new" onclick="addSingle('long-big')">+ å¤§å°è¯</button>
        <button class="btn-new" onclick="addSingle('long-small')">+ å°å°è¯</button>
        <button class="btn-new" onclick="addSingle('s4')">+ 4cmæ–—æ–¹</button>
    </div>

    <div class="btn-group" style="border:none; padding:0;">
        <button class="btn-std" onclick="addSingle('s15')">15cm</button>
        <button class="btn-std" onclick="addSingle('s10')">10cm</button>
        <button class="btn-std" onclick="addSingle('s5')">5cm</button>
        <button onclick="document.getElementById('a4-page').innerHTML=''" style="background:#757575; color:white;">æ¸…ç©º</button>
    </div>
    
    <button class="btn-save" onclick="handleExport()">ä¸‹è¼‰ A4 åˆ—å°åœ–ç‰‡</button>
    <p style="font-size: 11px; color: #888; margin-top: 5px;">é›»è…¦é»æ“Šç›´æ¥ä¸‹è¼‰ / æ‰‹æ©Ÿé»æ“Šé•·æŒ‰å„²å­˜</p>
</div>

<div class="preview-container">
    <div id="a4-page"></div>
</div>

<div id="result-overlay" onclick="this.style.display='none'">
    <p>é•·æŒ‰åœ–ç‰‡å„²å­˜è‡³ç›¸ç°¿</p>
    <img id="final-image">
    <button style="margin-top:20px; background:#555; color:white; border:none; padding:8px 20px;">é—œé–‰é è¦½</button>
</div>

<input type="file" id="fInput" style="display:none" accept="image/*">

<script>
    const a4 = document.getElementById('a4-page');
    const fInput = document.getElementById('fInput');
    let targetBox = null;

    function makeBox(cls) {
        const div = document.createElement('div');
        div.className = 'chun-lian ' + cls;
        div.onclick = (e) => { e.stopPropagation(); targetBox = div; fInput.value = ''; fInput.click(); };
        return div;
    }

    function addBestCombo15() {
        const row = document.createElement('div');
        row.className = 'combo-row';
        row.appendChild(makeBox('s15'));
        const v = document.createElement('div');
        v.className = 'v-stack';
        v.appendChild(makeBox('s5')); v.appendChild(makeBox('s5')); v.appendChild(makeBox('s5'));
        row.appendChild(v);
        canFit(row);
    }

    function addBestCombo10() {
        const row = document.createElement('div');
        row.className = 'combo-row';
        row.appendChild(makeBox('s10'));
        for(let i=0; i<2; i++) {
            const v = document.createElement('div');
            v.className = 'v-stack';
            v.appendChild(makeBox('s5')); v.appendChild(makeBox('s5'));
            row.appendChild(v);
        }
        canFit(row);
    }

    function addSingle(cls) { canFit(makeBox(cls)); }

    function canFit(el) {
        a4.appendChild(el);
        if (a4.scrollHeight > a4.clientHeight + 2) {
            alert("ç©ºé–“ä¸è¶³ï¼"); a4.removeChild(el); return false;
        }
        return true;
    }

    fInput.onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(event) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const maxDim = 1500; 
                let w = img.width, h = img.height;
                if (w > h && w > maxDim) { h *= maxDim / w; w = maxDim; }
                else if (h > maxDim) { w *= maxDim / h; h = maxDim; }
                canvas.width = w; canvas.height = h;
                ctx.drawImage(img, 0, 0, w, h);
                targetBox.innerHTML = '';
                const newImg = document.createElement('img');
                newImg.src = canvas.toDataURL('image/jpeg', 0.85);
                targetBox.appendChild(newImg);
                targetBox.style.border = "none";
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    };

    function handleExport() {
        if (a4.children.length === 0) return alert("è«‹å…ˆæ–°å¢æ˜¥è¯");
        
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        
        html2canvas(a4, { scale: 2.5, useCORS: true }).then(canvas => {
            const dataUrl = canvas.toDataURL('image/png');
            
            if (isMobile) {
                document.getElementById('final-image').src = dataUrl;
                document.getElementById('result-overlay').style.display = 'flex';
            } else {
                const link = document.createElement('a');
                link.download = 'custom_chunlian.png';
                link.href = dataUrl;
                link.click();
            }
        });
    }
</script>

<div style="text-align: center; margin-top: 20px;">
    <a href="../index.html" style="padding: 10px 20px; background-color: #f39c12; color: white; text-decoration: none; border-radius: 5px; font-weight: bold;">
        å›åˆ°ä¸Šä¸€é 
    </a>
</div>
</body>
</html>

